---
layout: post
title: "RNA-seq data analysis (strand issues)"
date: 2016-09-21
category: opinion
tags: [RNA-seq, analysis, strand, dUTP]
---

I had been working on strand-specific paired-end reads from HiSeq lately and I had trouble mapping reads back to assembled transcripts using STAR as well as using RSEM to estimate transcript abundance. 

<!--more-->

### Strand-specific protocol

{:refdef: style="text-align: left; font-size: 60%"}
| __Library Type__  | __Examples__ | __Description__ |
|:------------------|:-------------|:----------------|
| fr-unstranded |Standard Illumina|Reads from the left-most end of the fragment (in transcript coordinates) map to the transcript strand, and the right-most end maps to the opposite strand.|
| fr-firststrand | dUTP, NSR, NNSR | Same as above except we enforce the rule that the right-most end of the fragment (in transcript coordinates) is the first sequenced (or only sequenced for single-end reads). Equivalently, it is assumed that only the strand generated during first strand synthesis is sequenced.|
| fr-secondstrand | Ligation, Standard SOLiD | Same as above except we enforce the rule that the left-most end of the fragment (in transcript coordinates) is the first sequenced (or only sequenced for single-end reads). Equivalently, it is assumed that only the strand generated during second strand synthesis is sequenced.|
{: refdef}


### Bowtie and Tophat flags for strand-specific reads

Tophat uses --fr-firststrand for a library created by the dUTP method. This is stated clearly in the manual, so it is easy to understand. In contrast, Bowtie/Bowtie2 uses --fr, --rf, --ff to specify the orientation of paired-end reads.

--fr means the upstream read (/1) is from a forward strand and the downstream read (/2) is from a reverse strand.

--rf means the upstream read (/1) is from a reverse strand and the downstream read (/2) is from a forward strand.

--ff means both reads are from a forward strand.
![center](/figures/2016-09-21-RNA-seq-strand-issue/pe-orient.png) 
{:refdef: style="text-align: center"}
Summary of library type protocols (for Tophat/Bowtie)
{: refdef}

But regarding to which strand the RNA fragment is synthesized from, this involves different strand-specific protocols. Thanks to the illustration figure (see below) from Zhao Zhang, we could see that for example dUTP method is to only sequence the strand from the first strand synthesis (the original RNA strand is  degradated due to the dUTP incorporated), so the **/2 read** is from the original RNA strand.
![center](/figures/2016-09-21-RNA-seq-strand-issue/strand.png) 
{:refdef: style="text-align: center"}
Strand-specific library protocols (Credit: Zhao Zhang)
{: refdef}


***

### Running RSEM on dUTP reads

RSEM has --strand-specific flag that will turn on Bowtie --norc flag, which will force Bowtie to try to map the /1 reads to the forward strand only. This is suitable for reads generated by the ligation method. Also, the --strand-specific flag is equivalent to setting --forward-prob flag to 1.

However, for dUTP reads, the --forward-prob flag should be set to 0 instead. It will specify --nofw flag, which forces Bowtie to map the /1 reads to the reverse strand. Consequently, the --strand-specific flag should not be used when --forward-prob is set to 0. The --forward-prob flag not only specifies --nofw and --norc for Bowtie, but also modifies the orientation parameters of RSEM model.

For example, the command should look something like this:

`rsem-calculate-expression -p 8 --forward-prob 0 --paired-end sample_r1.fastq sample_r2.fastq index sample_output`

[**RSEM**](http://likit.github.io/running-bowtiebowtie2-rsem-and-tophat-on-dutp-strand-specific-reads.html "RNA-Seq by Expectation-Maximization")

### Running HTseq-count on dUTP reads

dUTP-based libraries convey strand with read #2, so htseq-count --stranded=reverse will produce sense counts for such datasets. Using --stranded=yes would then yield anti-sense counts. Htseq-count was unfortunately designed at a time when non-dUTP methods were still popular, so its default stranded option is opposite of what's now common.

For example, the command should look something like this:

`htseq-count --format=bam --order=pos --stranded=reverse --type=gene --idattr=gene_id --mode=union Aligned.toTranscriptome.out.bam Homo_sapiens.GRCh38.82.gtf`
